# Сервис LLM

Сервис для обработки текстовых и аудиозапросов с использованием языковых моделей. Обеспечивает возможности чат-бота, генерации ответов на основе контекста (RAG), поддержку аудио-запросов через ASR и работу с векторным хранилищем документов.

## Архитектура

Сервис построен на фреймворке FastAPI и использует следующие технологии:
- Языковые модели через LangChain
- Векторное хранилище на PostgreSQL
- ASR (автоматическое распознавание речи) для обработки аудио
- Интеграция с OpenAI и другими LLM
- Поддержка загрузки изображений и документов

## Зависимости

- Python >= 3.11
- FastAPI
- LangChain
- PostgreSQL
- OpenAI SDK
- python-docling (для парсинга документов)

## Основные возможности

- Обработка текстовых запросов пользователей
- Поддержка аудиозапросов (через ASR)
- Возможность прикрепления изображений к запросам
- Хранение истории диалогов
- Векторное хранилище документов для RAG (Retrieval Augmented Generation)
- Парсинг документов различных форматов
- Многоязычная поддержка

## Установка и запуск

1. Установите зависимости:
```bash
poetry install
```

2. Настройте переменные окружения в файле `.env`:
```bash
OPENAI_API_KEY=ваш_ключ
DB_USER=пользователь
DB_PASSWORD=пароль
DB_HOST=localhost
DB_PORT=5432
DB_NAME=название_базы
ASR_URL=url_сервиса_asr
SECRET_TOKEN=секретный_токен
```

3. Запустите сервис:
```bash
cd llm
python main.py
```

## Параметры конфигурации

Файл `config.py` содержит следующие параметры:
- `asr_url`: URL сервиса автоматического распознавания речи
- `secret_token`: Токен для генерации временных токенов доступа
- `db_url`: URL подключения к базе данных
- `openai_llm`: Конфигурация OpenAI LLM
- `embeddings`: Настройки эмбеддингов
- `docling_url`: URL сервиса для парсинга документов
- `docling_serve_api_key`: Ключ API для docling

## Эндпоинты

Сервис предоставляет следующие основные эндпоинты:

### Чат

- `POST /v1/chat/completion/text` - Обработка текстового запроса
- `POST /v1/chat/completion/audio` - Обработка аудиозапроса
- `POST /v1/chat/clear` - Очистка истории чата

### Векторное хранилище

- `POST /v1/remove/documents` - Удаление документов из векторного хранилища
- `POST /v1/parse/document` - Загрузка и парсинг документа

### Аутентификация

- `POST /generate-token` - Генерация токена доступа

Все эндпоинты защищены токеном аутентификации, за исключением `/generate-token`.

## Логика работы

1. Пользователь отправляет запрос (текстовый или аудио)
2. Если запрос аудио, он преобразуется в текст с помощью ASR
3. Запрос анализируется с учётом истории диалога
4. Проверяется наличие релевантных документов в векторном хранилище
5. Языковая модель формирует ответ на основе контекста
6. Ответ сохраняется в истории диалога
7. Ответ возвращается пользователю

## Безопасность

- Все эндпоинты требуют токена аутентификации
- Токены имеют срок действия 24 часа
- Доступ к генерации новых токенов ограничен секретным токеном